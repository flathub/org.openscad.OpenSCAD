app-id: org.openscad.OpenSCAD
runtime: org.kde.Platform
runtime-version: 5.15-22.08
sdk: org.kde.Sdk
command: openscad
rename-desktop-file: openscad-nightly.desktop
rename-icon: openscad-nightly
finish-args:
  - --socket=x11
  - --socket=fallback-x11
  - --socket=wayland
  - --share=ipc
  - --device=dri
  - --filesystem=home
  - --filesystem=/run/spnav.sock:ro
  - --env=SPNAV_SOCKET=/run/spnav.sock
cleanup:
  - /include
  - /lib/cmake
  - /lib/pkgconfig
  - /share/man
  - '*.a'
modules:
  - name: boost
    buildsystem: simple
    build-commands:
      - ./bootstrap.sh --with-libraries=filesystem,program_options,regex,thread,system
      - ./b2 -j $FLATPAK_BUILDER_N_JOBS install --prefix=/app
    sources:
      - type: archive
        url: https://boostorg.jfrog.io/artifactory/main/release/1.83.0/source/boost_1_83_0.tar.bz2
        sha256: 6478edfe2f3305127cffe8caf73ea0176c53769f4bf1585be237eb30798c3b8e
  - shared-modules/glew/glew.json
  - shared-modules/glu/glu-9.json
  - name: freeglut
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DCMAKE_INSTALL_LIBDIR:PATH=/app/lib
    build-options:
      cflags: -fcommon
      cxxflags: -fcommon
    sources:
      - type: archive
        url: https://github.com/FreeGLUTProject/freeglut/releases/download/v3.4.0/freeglut-3.4.0.tar.gz
        sha256: 3c0bcb915d9b180a97edaebd011b7a1de54583a838644dcd42bb0ea0c6f3eaec
  - name: libXmu
    sources:
      - type: archive
        url: https://www.x.org/archive/individual/lib/libXmu-1.1.4.tar.xz
        sha256: 210de3ab9c3e9382572c25d17c2518a854ce6e2c62c5f8315deac7579e758244
  - name: eigen
    builddir: true
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    cleanup:
      - /share
    sources:
      - type: archive
        url: https://gitlab.com/libeigen/eigen/-/archive/3.4.0/eigen-3.4.0.tar.bz2
        sha256: b4c198460eba6f28d34894e3a5710998818515104d6e74e5cc331ce31e46e626
  - name: mpfr
    sources:
      - type: archive
        url: https://www.mpfr.org/mpfr-current/mpfr-4.2.1.tar.xz
        sha256: 277807353a6726978996945af13e52829e3abd7a9a5b7fb2793894e18f1fcbb2
  - name: cgal
    cleanup:
      - /bin
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    sources:
      - type: archive
        url: https://github.com/CGAL/cgal/releases/download/v5.6/CGAL-5.6-library.zip
        sha256: aea66cfa617dfdb7450844969b2e0b2a3e83319fee1c358bc8b027943f64a247
  - name: opencsg
    no-autogen: true
    no-parallel-make: true
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://www.opencsg.org/OpenCSG-1.6.0.tar.gz
        sha256: bf8fb80e3e0ce11d87dd78dd15a0de872dbb8972d87f5f89cffc461efad47be8
      - type: patch
        path: opencsg-libs.patch
  - name: qscintilla
    buildsystem: qmake
    subdir: src
    sources:
      - type: archive
        url: https://www.riverbankcomputing.com/static/Downloads/QScintilla/2.14.1/QScintilla_src-2.14.1.tar.gz
        sha256: dfe13c6acc9d85dfcba76ccc8061e71a223957a6c02f3c343b30a9d43a4cdd4d
      - type: patch
        path: qscintilla-lib-paths.patch
  - name: double-conversion
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DCMAKE_INSTALL_LIBDIR:PATH=/app/lib
    sources:
      - type: archive
        url: https://github.com/google/double-conversion/archive/refs/tags/v3.3.0.tar.gz
        sha256: 04ec44461850abbf33824da84978043b22554896b552c5fd11a9c5ae4b4d296e
  - name: tbb
    buildsystem: cmake-ninja
    config-opts:
      - -DTBB_TEST=OFF
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DCMAKE_INSTALL_LIBDIR:PATH=/app/lib
    sources:
      - type: archive
        url: https://github.com/oneapi-src/oneTBB/archive/refs/tags/v2021.10.0.tar.gz
        sha256: 487023a955e5a3cc6d3a0d5f89179f9b6c0ae7222613a7185b0227ba0c83700b
  - name: libzip
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DCMAKE_INSTALL_LIBDIR:PATH=/app/lib
      - -DCMAKE_INSTALL_INCLUDEDIR:PATH=/app/include
    sources:
      - type: archive
        url: https://libzip.org/download/libzip-1.10.1.tar.xz
        sha256: dc3c8d5b4c8bbd09626864f6bcf93de701540f761d76b85d7c7d710f4bd90318
  - name: lib3mf
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DCMAKE_INSTALL_LIBDIR:PATH=/app/lib
      - -DLIB3MF_TESTS=OFF
      - -DUSE_INCLUDED_LIBZIP=OFF
    sources:
      - type: archive
        url: https://github.com/3MFConsortium/lib3mf/archive/v2.2.0.tar.gz
        sha256: 96e85e278fc5474123e3c47237dd42faaf1fdf8e182541a84af7fe84ddd3cbde
  - name: libspnav
    sources:
      - type: archive
        url: https://github.com/FreeSpacenav/libspnav/releases/download/v1.1/libspnav-1.1.tar.gz
        sha256: 04b297f68a10db4fa40edf68d7f823ba7b9d0442f2b665181889abe2cea42759
  - name: openscad
    buildsystem: cmake
    config-opts:
      - -DENABLE_TESTS=OFF
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DEXPERIMENTAL=ON
      - -DSNAPSHOT=ON
    cleanup:
      - /share/pixmaps
    sources:
      - type: git
        url: https://github.com/openscad/openscad.git
        commit: f41aefc37c7e1232ef0d0aea17022771b18be49b
    post-install:
      - mv /app/share/applications/openscad.desktop /app/share/applications/openscad-nightly.desktop
      - mv /app/share/mime/packages/openscad.xml /app/share/mime/packages/org.openscad.OpenSCAD.xml
      - sed -i -e 's|<icon name="openscad"/>|<icon name="org.openscad.OpenSCAD"/>|'
        /app/share/mime/packages/org.openscad.OpenSCAD.xml
      - export V=$(git log -1 --date="format:%Y.%m.%d.fp%j%H" --format="%cd");
        sed -i -e "/<releases>/a\\    <release date=\"$(date +%Y-%m-%d)\" version=\"$V\"/>"
        /app/share/metainfo/org.openscad.OpenSCAD.appdata.xml
