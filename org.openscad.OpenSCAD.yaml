app-id: org.openscad.OpenSCAD
runtime: org.kde.Platform
runtime-version: "6.8"
sdk: org.kde.Sdk
command: openscad-nightly
rename-icon: openscad-nightly
rename-mime-file: openscad-nightly.xml
rename-mime-icons:
  - openscad-nightly
rename-desktop-file: openscad-nightly.desktop
rename-appdata-file: org.openscad.OpenSCAD-nightly.appdata.xml
copy-icon: true
finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --share=ipc
  - --device=dri
  - --filesystem=home
  - --filesystem=/run/spnav.sock:ro
  - --env=SPNAV_SOCKET=/run/spnav.sock
cleanup:
  - /include
  - /lib/cmake
  - /lib/pkgconfig
  - /share/man
  - "*.a"
modules:
  - name: glm
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DCMAKE_INSTALL_LIBDIR:PATH=/app/lib
      - -DGLM_BUILD_TESTS=OFF
      - -DBUILD_SHARED_LIBS=OFF
    sources:
      - type: archive
        url: https://github.com/g-truc/glm/archive/refs/tags/1.0.1.tar.gz
        sha256: 9f3174561fd26904b23f0db5e560971cbf9b3cbda0b280f04d5c379d03bf234c
  - name: polyclipping2
    buildsystem: cmake-ninja
    builddir: true
    subdir: CPP
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DCMAKE_INSTALL_LIBDIR:PATH=/app/lib
      - -DCLIPPER2_UTILS=OFF
      - -DCLIPPER2_EXAMPLES=OFF
      - -DCLIPPER2_TESTS=OFF
    sources:
      - type: archive
        url: https://github.com/AngusJohnson/Clipper2/archive/refs/tags/Clipper2_1.5.2.tar.gz
        sha256: 61b60a8a668958dafcd39443f8e0973693425666161e3ca24227097617c4d288
  - name: boost
    buildsystem: simple
    build-commands:
      - ./bootstrap.sh --with-libraries=filesystem,program_options,regex,thread,system
      - ./b2 -j $FLATPAK_BUILDER_N_JOBS install --prefix=/app
    sources:
      - type: archive
        url: https://archives.boost.io/release/1.87.0/source/boost_1_87_0.tar.bz2
        sha256: af57be25cb4c4f4b413ed692fe378affb4352ea50fbe294a11ef548f4d527d89
  - shared-modules/glew/glew.json
  - shared-modules/glu/glu-9.json
  - name: freeglut
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DCMAKE_INSTALL_LIBDIR:PATH=/app/lib
    build-options:
      cflags: -fcommon
      cxxflags: -fcommon
    sources:
      - type: archive
        url: https://github.com/freeglut/freeglut/releases/download/v3.6.0/freeglut-3.6.0.tar.gz
        sha256: 9c3d4d6516fbfa0280edc93c77698fb7303e443c1aaaf37d269e3288a6c3ea52
  - name: libXmu
    sources:
      - type: archive
        url: https://www.x.org/archive/individual/lib/libXmu-1.2.1.tar.xz
        sha256: fcb27793248a39e5fcc5b9c4aec40cc0734b3ca76aac3d7d1c264e7f7e14e8b2
  - name: eigen
    builddir: true
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    cleanup:
      - /share
    sources:
      - type: archive
        url: https://gitlab.com/libeigen/eigen/-/archive/3.4.0/eigen-3.4.0.tar.bz2
        sha256: b4c198460eba6f28d34894e3a5710998818515104d6e74e5cc331ce31e46e626
  - name: mpfr
    sources:
      - type: archive
        url: https://www.mpfr.org/mpfr-current/mpfr-4.2.1.tar.xz
        sha256: 277807353a6726978996945af13e52829e3abd7a9a5b7fb2793894e18f1fcbb2
  - name: cgal
    cleanup:
      - /bin
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    sources:
      - type: archive
        url: https://github.com/CGAL/cgal/releases/download/v6.0.1/CGAL-6.0.1-library.tar.xz
        sha256: c752737f91d1af71fa96038f0e37945ce82a5f1fffb6200172cfcdd77755a356
  - name: qscintilla
    buildsystem: qmake
    subdir: src
    sources:
      - type: archive
        url: https://www.riverbankcomputing.com/static/Downloads/QScintilla/2.14.1/QScintilla_src-2.14.1.tar.gz
        sha256: dfe13c6acc9d85dfcba76ccc8061e71a223957a6c02f3c343b30a9d43a4cdd4d
      - type: patch
        path: patches/qscintilla-lib-paths.patch
  - name: double-conversion
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DCMAKE_INSTALL_LIBDIR:PATH=/app/lib
    sources:
      - type: archive
        url: https://github.com/google/double-conversion/archive/refs/tags/v3.3.1.tar.gz
        sha256: fe54901055c71302dcdc5c3ccbe265a6c191978f3761ce1414d0895d6b0ea90e
  - name: tbb
    buildsystem: cmake-ninja
    config-opts:
      - -DTBB_TEST=OFF
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DCMAKE_INSTALL_LIBDIR:PATH=/app/lib
    sources:
      - type: archive
        url: https://github.com/uxlfoundation/oneTBB/archive/refs/tags/v2022.0.0.tar.gz
        sha256: e8e89c9c345415b17b30a2db3095ba9d47647611662073f7fbf54ad48b7f3c2a
  - name: libzip
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DCMAKE_INSTALL_LIBDIR:PATH=/app/lib
      - -DCMAKE_INSTALL_INCLUDEDIR:PATH=/app/include
    sources:
      - type: archive
        url: https://libzip.org/download/libzip-1.11.3.tar.xz
        sha256: 9509d878ba788271c8b5abca9cfde1720f075335686237b7e9a9e7210fe67c1b
  - name: lib3mf
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DCMAKE_INSTALL_LIBDIR:PATH=/app/lib
      - -DLIB3MF_TESTS=OFF
      - -DUSE_INCLUDED_ZLIB=OFF
      - -DUSE_INCLUDED_LIBZIP=OFF
    sources:
      - type: archive
        url: https://github.com/3MFConsortium/lib3mf/archive/refs/tags/v2.4.1.tar.gz
        sha256: 081dea66ddd1b958644bfac0fe9a580e63726061459efce5190a10161082f8f7
      - type: patch
        path: patches/lib3mf-2.4.1_inc_algorithm.patch
  - name: libspnav
    sources:
      - type: archive
        url: https://github.com/FreeSpacenav/libspnav/releases/download/v1.1/libspnav-1.1.tar.gz
        sha256: 04b297f68a10db4fa40edf68d7f823ba7b9d0442f2b665181889abe2cea42759
  - name: libcudacxx
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DLIBCUDACXX_ENABLE_CUDA=OFF
      - -DLIBCUDACXX_ENABLE_LIBCUDACXX_TESTS=OFF
    sources:
      - type: archive
        url: https://github.com/NVIDIA/libcudacxx/archive/refs/tags/1.9.0.tar.gz
        sha256: 05b1435ad65f5bdef1bb8d1eb29dc8f0f7df34c01d77bf8686687a4603588bce
      # make install patch from debian package
      - type: patch
        path: patches/0002-Correct-issues-with-CMake-install-rules-331.patch
  - name: thrust
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DTHRUST_ENABLE_TESTING=OFF
      - -DTHRUST_ENABLE_EXAMPLES=OFF
      - -DTHRUST_INSTALL_CUB_HEADERS=OFF
      - -DTHRUST_INSTALL_LIBCUDACXX_HEADERS=OFF
      - -DTHRUST_HOST_SYSTEM=TBB
      - -DTHRUST_DEVICE_SYSTEM=TBB
    sources:
      - type: archive
        url: https://github.com/NVIDIA/thrust/archive/refs/tags/2.1.0.tar.gz
        sha256: ebfa1a31867a95b8b0555ae45fc7c45538edfa5929ec718951eae0bbc7ed3108
  - name: openscad
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DUSE_BUILTIN_OPENCSG=ON
      - -DMANIFOLD_PYBIND=OFF
      - -DMANIFOLD_TEST=OFF
      - -DENABLE_PYTHON=ON
      - -DENABLE_TESTS=OFF
      - -DEXPERIMENTAL=ON
      - -DSUFFIX=nightly
      - -DSNAPSHOT=ON
      - -DUSE_QT6=ON
    cleanup:
      - /share/pixmaps
    sources:
      - type: git
        url: https://github.com/openscad/openscad.git
        commit: ce5039f8a9545ad5a8cf197b3ca11c0939bc67f1
    post-install:
      - sed -i -e 's/\(<id>org.openscad.OpenSCAD\)-nightly/\1/' /app/share/metainfo/org.openscad.OpenSCAD-nightly.appdata.xml
